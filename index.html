<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pesquisa de Decretos</title>

  <style>
    body{font-family:Arial, sans-serif; margin:40px; line-height:1.4}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input{width:420px; max-width:100%; padding:10px; font-size:16px}
    button{padding:10px 14px; font-size:16px; cursor:pointer}
    .box{margin-top:12px; border:1px solid #ccc; padding:12px}
    .ok{background:#f6ffed; border-color:#b7eb8f}
    .bad{background:#fff1f0; border-color:#ffa39e}
    .card{border:1px solid #999; padding:14px; margin-top:18px}
    .pill{display:inline-block; border:1px solid #ccc; padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px}
    mark{background:yellow; font-weight:bold}
    pre{white-space:pre-wrap; word-wrap:break-word; background:#f7f7f7; border:1px solid #e5e5e5; padding:12px; max-height:420px; overflow:auto;}
  </style>

  <script src="libs/pdf.min.js"></script>
</head>
<body>
  <h2>Pesquisa de Decretos</h2>

  <div class="row">
    <input id="q" placeholder="Digite imóvel/ocupação/endereço..." />
    <button id="btnIndex">Indexar decretos</button>
    <button id="btnSearch" disabled>Pesquisar</button>
  </div>

  <div id="status" class="box ok">Clique em <b>Indexar decretos</b>.</div>
  <div id="results"></div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "libs/pdf.worker.min.js";

  const DECRETO_FILES = [
    "Decreto n°159.pdf","Decreto n°201.pdf","Decreto n°392.pdf","Decreto n°275.pdf",
    "Decreto n°507.pdf","Decreto n°680.pdf","Decreto n° 576.pdf","Decreto n° 561.pdf",
    "Decreto n°425.pdf","Decreto n°310.pdf","Decreto n°482.pdf","Decreto n°213.pdf",
    "Decreto n°250.pdf","Decreto n°265.pdf","Decreto n°464.pdf","Decreto n°338.pdf"
  ];

  const $status = document.getElementById("status");
  const $results = document.getElementById("results");
  const $btnIndex = document.getElementById("btnIndex");
  const $btnSearch = document.getElementById("btnSearch");
  const $q = document.getElementById("q");

  let decrees = [];
  let indexed = false;

  function setOk(msg){ $status.className="box ok"; $status.innerHTML = msg; }
  function setBad(msg){ $status.className="box bad"; $status.innerHTML = msg; }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function highlight(text, term){
    if(!term) return escapeHtml(text);
    const safe = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const re = new RegExp(safe, "gi");
    return escapeHtml(text).replace(re, m => `<mark>${m}</mark>`);
  }

  async function extractTextFromPdfUrl(url){
    const loadingTask = pdfjsLib.getDocument(url);
    const pdf = await loadingTask.promise;

    const pages = [];
    let fullText = "";

    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const textContent = await page.getTextContent();
      const strings = textContent.items.map(it => it.str).filter(Boolean);
      const pageText = strings.join(" ").replace(/\s+/g," ").trim();
      pages.push({ page: p, text: pageText });
      fullText += (pageText ? pageText + "\n\n" : "");
    }
    return { pages, fullText: fullText.trim() };
  }

  function guessTitle(text, fallback){
    const m = (text||"").match(/DECRETO\s+N[º°]\s*\.?\s*([0-9]+)/i);
    return m ? `Decreto nº ${m[1]}` : fallback.replace(/\.pdf$/i,"");
  }

  function findPagesWithTerm(pages, term){
    const t = term.toLowerCase();
    return pages.filter(p => (p.text||"").toLowerCase().includes(t)).map(p => p.page);
  }

  function renderResult(decree, term){
    const hitPages = findPagesWithTerm(decree.pages, term);
    const pagesHtml = hitPages.length
      ? hitPages.map(n => `<span class="pill">p. ${n}</span>`).join(" ")
      : `<span class="pill">sem página</span>`;

    return `
      <div class="card">
        <b>${escapeHtml(decree.title)}</b> <span style="color:#666">(${escapeHtml(decree.file)})</span><br>
        <div style="margin:6px 0 10px 0">${pagesHtml}</div>
        <pre>${highlight(decree.fullText, term)}</pre>
      </div>
    `;
  }

  $btnIndex.addEventListener("click", async () => {
    decrees = [];
    indexed = false;
    $results.innerHTML = "";
    $btnSearch.disabled = true;

    try{
      for(let i=0; i<DECRETO_FILES.length; i++){
        const file = DECRETO_FILES[i];
        const url = `decretos/${encodeURIComponent(file)}`;
        setOk(`Indexando <b>${i+1}/${DECRETO_FILES.length}</b>: ${escapeHtml(file)}`);
        const data = await extractTextFromPdfUrl(url);

        decrees.push({
          file,
          title: guessTitle(data.fullText, file),
          pages: data.pages,
          fullText: data.fullText
        });
      }
      indexed = true;
      $btnSearch.disabled = false;
      setOk(`Indexação concluída ✅ Decretos: <b>${DECRETO_FILES.length}</b>.`);
    }catch(e){
      setBad(`Erro ao indexar: <b>${escapeHtml(e.message || String(e))}</b><br>
      Confirme se os PDFs estão em <b>decretos/</b> e se os nomes na lista batem 100%.`);
    }
  });

  $btnSearch.addEventListener("click", () => {
    if(!indexed){ setBad("Indexe primeiro."); return; }
    const term = ($q.value||"").trim();
    $results.innerHTML = "";
    if(!term){ setBad("Digite um termo para pesquisar."); return; }

    const hits = decrees.filter(d => (d.fullText||"").toLowerCase().includes(term.toLowerCase()));
    setOk(`Resultados: <b>${hits.length}</b> decreto(s) para “<b>${escapeHtml(term)}</b>”.`);

    $results.innerHTML = hits.length
      ? hits.map(d => renderResult(d, term)).join("")
      : `<div class="card">Nenhum decreto contém esse termo (ou algum PDF não tem texto).</div>`;
  });

  $q.addEventListener("keydown", (e) => { if(e.key === "Enter") $btnSearch.click(); });
</script>
</body>
</html>

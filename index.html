<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pesquisa de Decretos</title>

  <style>
    body{font-family:Arial, sans-serif; margin:40px; line-height:1.4}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input{width:420px; max-width:100%; padding:10px; font-size:16px}
    button{padding:10px 14px; font-size:16px; cursor:pointer}
    .box{margin-top:12px; border:1px solid #ccc; padding:12px}
    .ok{background:#f6ffed; border-color:#b7eb8f}
    .bad{background:#fff1f0; border-color:#ffa39e}
    .card{border:1px solid #999; padding:14px; margin-top:18px}
    .pill{display:inline-block; border:1px solid #ccc; padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px}
    mark{background:yellow; font-weight:bold}
    pre{
      white-space:pre-wrap;
      word-wrap:break-word;
      background:#f7f7f7;
      border:1px solid #e5e5e5;
      padding:12px;
      max-height:420px;
      overflow:auto;
    }
  </style>

  <!-- PDF.js OFFLINE -->
  <script src="libs/pdf.min.js"></script>
</head>
<body>

<h2>Pesquisa de Decretos</h2>

<div class="row">
  <input id="q" placeholder="Digite imóvel, ocupação, endereço..." />
  <button id="btnIndex">Indexar decretos</button>
  <button id="btnSearch" disabled>Pesquisar</button>
</div>

<div id="status" class="box ok">
  Clique em <b>Indexar decretos</b> para carregar a base.
</div>

<div id="results"></div>

<script>
  // Worker do PDF.js
  pdfjsLib.GlobalWorkerOptions.workerSrc = "libs/pdf.worker.min.js";

  // LISTA FIXA DOS DECRETOS (nomes simples)
  const DECRETO_FILES = [
    "decreto_159.pdf",
    "decreto_201.pdf",
    "decreto_392.pdf",
    "decreto_275.pdf",
    "decreto_507.pdf",
    "decreto_680.pdf",
    "decreto_576.pdf",
    "decreto_561.pdf",
    "decreto_425.pdf",
    "decreto_310.pdf",
    "decreto_482.pdf",
    "decreto_213.pdf",
    "decreto_250.pdf",
    "decreto_265.pdf",
    "decreto_464.pdf",
    "decreto_338.pdf",
    "decreto_332.pdf",
    "decreto_348.pdf"
  ];

  const statusBox = document.getElementById("status");
  const results = document.getElementById("results");
  const btnIndex = document.getElementById("btnIndex");
  const btnSearch = document.getElementById("btnSearch");
  const q = document.getElementById("q");

  let decrees = [];
  let indexed = false;

  function setOk(msg){
    statusBox.className = "box ok";
    statusBox.innerHTML = msg;
  }

  function setBad(msg){
    statusBox.className = "box bad";
    statusBox.innerHTML = msg;
  }

  function escapeHtml(s){
    return (s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function highlight(text, term){
    if(!term) return escapeHtml(text);
    const safe = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const re = new RegExp(safe, "gi");
    return escapeHtml(text).replace(re, m => `<mark>${m}</mark>`);
  }

  async function extractTextFromPdf(url){
    const loadingTask = pdfjsLib.getDocument(url);
    const pdf = await loadingTask.promise;

    const pages = [];
    let fullText = "";

    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const textContent = await page.getTextContent();
      const strings = textContent.items.map(it => it.str).filter(Boolean);
      const pageText = strings.join(" ").replace(/\s+/g," ").trim();

      pages.push({ page: p, text: pageText });
      fullText += pageText + "\n\n";
    }

    return { pages, fullText: fullText.trim() };
  }

  function guessTitle(text, fallback){
    const m = (text||"").match(/DECRETO\s+N[º°]?\s*\.?\s*(\d+)/i);
    return m ? `Decreto nº ${m[1]}` : fallback;
  }

  function findPages(pages, term){
    const t = term.toLowerCase();
    return pages
      .filter(p => (p.text||"").toLowerCase().includes(t))
      .map(p => p.page);
  }

  function renderResult(d, term){
    const hitPages = findPages(d.pages, term);
    const pagesHtml = hitPages.length
      ? hitPages.map(n => `<span class="pill">p. ${n}</span>`).join(" ")
      : `<span class="pill">sem página</span>`;

    return `
      <div class="card">
        <b>${escapeHtml(d.title)}</b>
        <div style="margin:6px 0 10px 0">${pagesHtml}</div>
        <pre>${highlight(d.fullText, term)}</pre>
      </div>
    `;
  }

  btnIndex.addEventListener("click", async () => {
    decrees = [];
    indexed = false;
    results.innerHTML = "";
    btnSearch.disabled = true;

    try{
      for(let i=0; i<DECRETO_FILES.length; i++){
        const file = DECRETO_FILES[i];
        const url = `decretos/${file}`;
        setOk(`Indexando ${i+1}/${DECRETO_FILES.length}: <b>${file}</b>`);

        const data = await extractTextFromPdf(url);

        decrees.push({
          file,
          title: guessTitle(data.fullText, file),
          pages: data.pages,
          fullText: data.fullText
        });
      }

      indexed = true;
      btnSearch.disabled = false;
      setOk(`Indexação concluída ✅ ${DECRETO_FILES.length} decretos carregados.`);
    }catch(e){
      setBad(
        `Erro ao indexar.<br><b>${escapeHtml(e.message)}</b><br>
         Confirme se os PDFs estão na pasta <b>decretos/</b> com os nomes corretos.`
      );
    }
  });

  btnSearch.addEventListener("click", () => {
    if(!indexed){
      setBad("Indexe os decretos primeiro.");
      return;
    }

    const term = q.value.trim();
    results.innerHTML = "";

    if(!term){
      setBad("Digite um termo para pesquisar.");
      return;
    }

    const hits = decrees.filter(d =>
      (d.fullText||"").toLowerCase().includes(term.toLowerCase())
    );

    setOk(`Resultados: <b>${hits.length}</b> decreto(s) para “${escapeHtml(term)}”.`);

    results.innerHTML = hits.length
      ? hits.map(d => renderResult(d, term)).join("")
      : `<div class="card">Nenhum decreto contém esse termo.</div>`;
  });

  q.addEventListener("keydown", e => {
    if(e.key === "Enter") btnSearch.click();
  });
</script>

</body>
</html>
